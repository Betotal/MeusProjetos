@page "/Account/Profile"
@rendermode InteractiveServer
@using ERPModular.Shared.Domain.Models
@using ERPModular.Shared.Infrastructure.Persistence
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@inject IServiceScopeFactory ScopeFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<div class="profile-container animate__animated animate__fadeIn">
    <div class="profile-card animate__animated animate__zoomIn">
        <div class="profile-header">
            <h4 class="mb-0 text-dark fw-bold"><i class="fas fa-user-circle me-2"></i>Meu Perfil</h4>
        </div>
        <div class="profile-body p-4">
            @if (user == null)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-accent" role="status"></div>
                </div>
            }
            else
            {
                <div class="mb-3 text-center">
                    <div class="avatar-large mx-auto mb-2 shadow-lg">@user.DisplayName?[0]</div>
                    <h4 class="mb-1 fw-bold">@user.FullName</h4>
                    <span class="badge bg-secondary rounded-pill px-3 py-1 small">@user.Email</span>
                </div>

                <EditForm Model="profileModel" OnValidSubmit="HandleUpdate" FormName="profileForm">
                    <DataAnnotationsValidator />
                    
                    <div class="mb-4">
                        <label class="form-label text-white-50 small fw-bold">NOME DE EXIBIÇÃO</label>
                        <div class="input-wrapper">
                            <i class="fas fa-user-tag text-white-50"></i>
                            <InputText @bind-Value="profileModel.DisplayName" class="form-control" placeholder="Como quer ser chamado?" />
                        </div>
                        <ValidationMessage For="@(() => profileModel.DisplayName)" class="text-danger small mt-2" />
                    </div>

                    @if (!string.IsNullOrEmpty(successMessage))
                    {
                        <div class="alert alert-success border-0 bg-success bg-opacity-10 text-success small animate__animated animate__fadeIn">
                            <i class="fas fa-check-circle me-1"></i> @successMessage
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger border-0 bg-danger bg-opacity-10 text-danger small animate__animated animate__shakeX">
                            <i class="fas fa-exclamation-circle me-1"></i> @errorMessage
                        </div>
                    }

                    <div class="d-grid gap-3 mt-5">
                        <button type="submit" class="btn btn-accent btn-lg py-3 fw-bold rounded-4 shadow" disabled="@isSaving">
                            @if (isSaving) { <span class="spinner-border spinner-border-sm me-2"></span> }
                            <i class="fas fa-save me-2"></i>Salvar Alterações
                        </button>
                        <button type="button" class="btn btn-outline-secondary py-3 rounded-4" @onclick="GoBack">Cancelar</button>
                    </div>
                </EditForm>
            }
        </div>
    </div>
</div>

<style>
    .profile-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: calc(100vh - 70px);
        background: radial-gradient(circle at top right, #1e293b, #0f172a);
        padding: 20px;
    }
    .profile-card {
        background: rgba(30, 41, 59, 0.6);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 20px; /* Reduzido de 28px */
        width: 100%;
        max-width: 450px; /* Reduzido de 500px */
        color: white;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
        overflow: hidden;
    }
    .profile-header {
    background: #38bdf8;
    padding: 15px 25px; /* Reduzido padding vertical */
    text-align: center;
}
    .text-accent { color: #38bdf8; }
    .btn-accent { background: #38bdf8; color: #0f172a; border: none; transition: all 0.3s ease; }
    .btn-accent:hover { background: #0ea5e9; transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(56, 189, 248, 0.3); }
    
    .avatar-large {
        width: 70px; /* Reduzido de 100px */
        height: 70px; /* Reduzido de 100px */
        background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
        color: #0f172a;
        border-radius: 20px; /* Reduzido de 30px */
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem; /* Reduzido de 3rem */
        font-weight: 800;
        border: 4px solid rgba(255, 255, 255, 0.1);
    }

    .input-wrapper { position: relative; }
    .input-wrapper i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); }
    
    .form-control {
        background: rgba(15, 23, 42, 0.8) !important;
        border: 1px solid rgba(148, 163, 184, 0.3);
        color: white !important;
        padding: 14px 14px 14px 45px;
        border-radius: 14px;
        transition: all 0.3s;
    }
    .form-control:focus {
        background-color: #0f172a !important;
        border-color: #38bdf8;
        box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.2);
        outline: none;
    }
</style>

@code {
    private ERPUser? user;
    private ProfileModel profileModel = new();
    private bool isSaving = false;
    private string? successMessage;
    private string? errorMessage;
    private List<string> debugLogs = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var principal = authState.User;
        
        if (principal.Identity?.IsAuthenticated == true)
        {
            using var scope = ScopeFactory.CreateScope();
            var userManager = scope.ServiceProvider.GetRequiredService<UserManager<ERPUser>>();
            
            user = await userManager.GetUserAsync(principal);
            if (user != null)
            {
                if (!user.IsActive)
                {
                    Navigation.NavigateTo("/Account/Restricted?reason=user_blocked");
                    return;
                }
                profileModel.DisplayName = user.DisplayName ?? "";
            }
        }
    }

    private async Task HandleUpdate()
    {
        if (user == null) return;

        isSaving = true;
        successMessage = null;
        errorMessage = null;

        try
        {
            using var scope = ScopeFactory.CreateScope();
            var userManager = scope.ServiceProvider.GetRequiredService<UserManager<ERPUser>>();
            var dbContext = scope.ServiceProvider.GetRequiredService<SharedDbContext>();
            
            // Busca o usuário atualizado
            var dbUser = await userManager.FindByIdAsync(user.Id);
            
            if (dbUser == null) 
            {
                errorMessage = "Usuário não encontrado no banco de dados.";
                return;
            }

            // Atualiza o DisplayName
            var oldDisplayName = dbUser.DisplayName;
            dbUser.DisplayName = profileModel.DisplayName;

            var result = await userManager.UpdateAsync(dbUser);
            
            if (result.Succeeded)
            {
                // Registrar Auditoria
                var auditLog = new AdminAuditLog
                {
                    UsuarioId = dbUser.Id,
                    UsuarioNome = dbUser.Email ?? "Desconhecido",
                    Acao = "Atualização de Perfil",
                    Detalhes = $"Usuário alterou seu Nome de Exibição de '{oldDisplayName}' para '{dbUser.DisplayName}'.",
                    TenantId = dbUser.TenantId,
                    DataHora = DateTime.UtcNow
                };
                
                dbContext.AdminAuditLogs.Add(auditLog);
                await dbContext.SaveChangesAsync();

                successMessage = "Perfil atualizado com sucesso! Recarregando...";
                StateHasChanged();
                
                await Task.Delay(2000);
                Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
            }
            else
            {
                errorMessage = "Erro ao atualizar perfil: " + string.Join(", ", result.Errors.Select(e => e.Description));
            }
        }
        catch (NavigationException)
        {
            throw;
        }
        catch (Exception ex)
        {
            errorMessage = $"Erro interno ao salvar: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void GoBack() => Navigation.NavigateTo("/");

    public class ProfileModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "O nome de exibição é obrigatório")]
        [System.ComponentModel.DataAnnotations.StringLength(30, ErrorMessage = "Máximo de 30 caracteres")]
        [System.ComponentModel.DataAnnotations.RegularExpression(@"^[a-zA-Záàâãéèêíïóôõöúçñ\s]+$", ErrorMessage = "Somente letras e espaços são permitidos")]
        public string DisplayName { get; set; } = "";
    }
}
