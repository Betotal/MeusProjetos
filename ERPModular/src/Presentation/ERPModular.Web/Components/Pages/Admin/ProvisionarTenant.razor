@page "/Admin/Provisionar"
@using ERPModular.Shared.Domain.Models
@using ERPModular.Shared.Infrastructure.Persistence
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@attribute [Authorize(Roles = "SuperAdmin")]
@rendermode InteractiveServer
@inject SharedDbContext DbContext
@inject UserManager<ERPUser> UserManager
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime

<div class="provision-container">
    <div class="provision-card theme-card border-0 shadow-lg p-4 p-md-5 rounded-4">
        <div class="header mb-4 pb-2 border-bottom">
            <h3 class="theme-text-header fw-bold mb-1"><i class="bi bi-person-plus-fill me-2"></i>Provisionar Novo Tenant</h3>
            <p class="text-subtitle">Cadastre um novo cliente e gere o link de convite.</p>
        </div>

        @if (InviteLinkGenerated)
        {
            <div class="invite-success animate__animated animate__zoomIn">
                <div class="text-center mb-4">
                    <div class="success-icon mb-3">
                        <i class="fas fa-check-circle fa-4x text-success"></i>
                    </div>
                    <h4 class="theme-text fw-bold">Tenant Provisionado!</h4>
                    <p class="text-subtitle">Compartilhe o link de onboarding com <strong>@Model.NomeSugerido</strong></p>
                </div>

                <div class="link-box p-3 rounded-4 bg-primary bg-opacity-10 border border-info border-opacity-25 mb-4">
                    <code class="text-accent small text-break">@InviteLink</code>
                </div>

                <div class="d-grid gap-3">
                    <button class="btn btn-success btn-lg py-3 rounded-4 shadow-sm" @onclick="SendWhatsApp">
                        <i class="fab fa-whatsapp me-2"></i> Enviar via WhatsApp
                    </button>
                    <button class="btn @(IsDarkMode ? "btn-outline-light" : "btn-outline-secondary") btn-lg py-3 rounded-4" @onclick="CopyLink">
                        <i class="fas fa-copy me-2"></i> @CopyButtonText
                    </button>
                    <button class="btn btn-link text-subtitle mt-2" @onclick="() => InviteLinkGenerated = false">Provisionar Outro</button>
                </div>
            </div>
        }
        else
        {
            <EditForm Model="Model" OnValidSubmit="HandleProvisioning">
                <DataAnnotationsValidator />

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-subtitle">E-mail do Cliente (Login)</label>
                        <InputText @bind-Value="Model.Email" class="form-control theme-input" placeholder="cliente@email.com" />
                        <ValidationMessage For="() => Model.Email" class="text-danger" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-subtitle">Nome Sugerido (Admin)</label>
                        <InputText @bind-Value="Model.NomeSugerido" class="form-control theme-input" placeholder="Ex: João da Silva" />
                        <ValidationMessage For="() => Model.NomeSugerido" class="text-danger" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-subtitle">Papel do Convidado</label>
                        <div class="d-flex gap-4">
                            <div class="form-check custom-radio">
                                <input class="form-check-input" type="radio" name="papel" id="roleOwner" value="Owner" 
                                       checked="@(Model.Papel == "Owner")" @onchange='() => Model.Papel = "Owner"'>
                                <label class="form-check-label theme-text" for="roleOwner">
                                    <i class="bi bi-star-fill text-warning me-1"></i> Dono
                                </label>
                            </div>
                            <div class="form-check custom-radio">
                                <input class="form-check-input" type="radio" name="papel" id="roleAdmin" value="Admin"
                                       checked="@(Model.Papel == "Admin")" @onchange='() => Model.Papel = "Admin"'>
                                <label class="form-check-label theme-text" for="roleAdmin">
                                    <i class="bi bi-shield-lock-fill text-info me-1"></i> Administrador
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-subtitle">Empresa Sugerida</label>
                        <InputText @bind-Value="Model.EmpresaSugerida" class="form-control theme-input" placeholder="Ex: Confecção Estrela" />
                        <ValidationMessage For="() => Model.EmpresaSugerida" class="text-danger" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-subtitle">Segmento (Domínio)</label>
                        <InputSelect @bind-Value="Model.DomainId" class="form-select theme-input">
                            <option value="">Selecione um domínio...</option>
                            @foreach (var dom in Dominios)
                            {
                                <option value="@dom.Id">@dom.Nome</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="() => Model.DomainId" class="text-danger" />
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(Message))
                {
                    <div class="alert @(IsError ? "alert-danger" : "alert-success")">
                        @Message
                    </div>
                }

                <div class="actions mt-4">
                    <button type="submit" class="btn btn-primary w-100 py-3" disabled="@IsProcessing">
                        @if (IsProcessing)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span> <span>Processando...</span>
                        }
                        else
                        {
                            <span><i class="bi bi-rocket-takeoff me-2"></i>Provisionar e Gerar Convite</span>
                        }
                    </button>
                </div>
            </EditForm>
        }
    </div>
</div>

@code {
    private ProvisionModel Model = new();
    private List<Dominio> Dominios = new();
    private string? Message;
    private bool IsError;
    private bool IsProcessing;
    private string? InviteLink;
    private bool InviteLinkGenerated;
    private string CopyButtonText = "Copiar Link";

    private bool IsDarkMode = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var theme = await JSRuntime.InvokeAsync<string>("getTheme");
            IsDarkMode = theme == "dark";
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        Dominios = await DbContext.Dominios.Where(d => d.Ativo).ToListAsync();
    }

    private async Task HandleProvisioning()
    {
        IsProcessing = true;
        Message = null;
        InviteLink = null;

        try
        {
            // 1. Validar se usuário já existe
            var existing = await UserManager.FindByEmailAsync(Model.Email);
            if (existing != null)
            {
                IsError = true;
                Message = "Este e-mail já está cadastrado no sistema.";
                IsProcessing = false;
                return;
            }

            // 2. Gerar TenantId único
            var tenantId = $"tenant-{Guid.NewGuid().ToString("N")[..8]}";

            // 3. Criar Tenant
            var tenant = new Tenant
            {
                Id = tenantId,
                NomeFantasia = Model.EmpresaSugerida,
                DomainId = Model.DomainId,
                Ativo = true
            };
            DbContext.Tenants.Add(tenant);

            // 4. Criar Licença (Trial de 30 dias)
            var licenca = new Licenca
            {
                Id = Guid.NewGuid(),
                TenantId = tenantId,
                DomainId = Model.DomainId,
                Ativa = true,
                InicioValidade = DateTime.UtcNow,
                FimValidade = DateTime.UtcNow.AddDays(30)
            };
            DbContext.Licencas.Add(licenca);

            // 5. Salvar Tenant e Licença
            await DbContext.SaveChangesAsync();

            // 6. Criar ERPUser
            var invitationToken = Guid.NewGuid().ToString("N");
            var user = new ERPUser
            {
                UserName = Model.Email,
                Email = Model.Email,
                FullName = Model.NomeSugerido,
                DisplayName = Model.NomeSugerido.Split(' ')[0], // Sugestão: Primeiro nome
                DomainId = Model.DomainId,
                TenantId = tenantId,
                EmpresaId = "matriz",
                EmailConfirmed = true,
                InvitationAccepted = false, // Importante: Indica que ainda não fez o onboarding
                InvitationToken = invitationToken,
                IsActive = true,
                CreatedAt = DateTime.UtcNow,
                Funcao = Model.Papel == "Owner" ? "Diretor" : "Gerente",
                NivelAcesso = "Total"
            };

            // Senha temporária aleatória
            var tempPassword = "Tmp@" + Guid.NewGuid().ToString("N")[..8];
            var result = await UserManager.CreateAsync(user, tempPassword);
            if (result.Succeeded)
            {
                await UserManager.AddToRoleAsync(user, Model.Papel);
                
                // AUDITORIA: Registrar provisionamento
                var authState = await AuthStateProvider.GetAuthenticationStateAsync();
                var currentUserId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "unknown";
                var currentUserName = authState.User.Identity?.Name ?? "Desconhecido";
                
                var auditLog = new AdminAuditLog
                {
                    UsuarioId = currentUserId,
                    UsuarioNome = currentUserName,
                    Acao = "Provisionamento de Tenant",
                    Detalhes = $"Novo tenant '{tenant.NomeFantasia}' (ID: {tenantId}) criado para o domínio '{Model.DomainId}'. Usuário inicial: {Model.Email} com papel '{Model.Papel}'.",
                    TenantId = tenantId
                };
                
                DbContext.AdminAuditLogs.Add(auditLog);
                await DbContext.SaveChangesAsync();
                
                IsError = false;
                Message = "Tenant provisionado com sucesso!";
                
                // 7. Gerar link de convite padrão
                InviteLink = $"{Navigation.BaseUri}Account/Onboarding?email={Uri.EscapeDataString(Model.Email)}&token={invitationToken}";
                InviteLinkGenerated = true;
            }
            else
            {
                IsError = true;
                Message = "Erro ao criar usuário: " + string.Join(", ", result.Errors.Select(e => e.Description));
            }
        }
        catch (Exception ex)
        {
            IsError = true;
            Message = "Erro interno: " + ex.Message;
        }
        finally
        {
            IsProcessing = false;
        }
    }

    public class ProvisionModel
    {
        [Required(ErrorMessage = "O e-mail é obrigatório")]
        [EmailAddress(ErrorMessage = "E-mail inválido")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "O nome é obrigatório")]
        public string NomeSugerido { get; set; } = "";

        [Required(ErrorMessage = "O nome da empresa é obrigatório")]
        public string EmpresaSugerida { get; set; } = "";

        [Required(ErrorMessage = "O segmento é obrigatório")]
        public string DomainId { get; set; } = "";

        [Required]
        public string Papel { get; set; } = "Owner";
    }

    private async Task CopyLink()
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", InviteLink);
        CopyButtonText = "Copiado! ✅";
        await Task.Delay(2000);
        CopyButtonText = "Copiar Link";
    }

    private async Task SendWhatsApp()
    {
        var message = $"Olá {Model.NomeSugerido}! Seja bem-vindo ao ERPModular. Para ativar a conta da sua empresa ({Model.EmpresaSugerida}), acesse o link: {InviteLink}";
        var url = $"https://wa.me/?text={Uri.EscapeDataString(message)}";
        await JSRuntime.InvokeVoidAsync("window.open", url, "_blank");
    }
}

<style>
    .provision-container {
        display: flex;
        justify-content: center;
        padding-top: 50px;
    }

    .btn-primary {
        background: var(--accent);
        color: #0f172a;
        font-weight: 700;
        border: none;
        padding: 14px;
        border-radius: 8px;
    }
    .btn-primary:hover {
        background: #0ea5e9;
    }
    .alert { font-size: 0.9rem; margin-top: 20px; }

    .custom-radio { cursor: pointer; padding: 10px 15px; border-radius: 8px; background: var(--bg-primary); border: 1px solid var(--border-color); transition: all 0.2s; }
    .custom-radio:hover { background: rgba(56, 189, 248, 0.1); border-color: var(--accent); }
    .form-check-input:checked + .form-check-label { color: var(--accent); }

    /* Estilos do Sucesso (Premium) */
    .invite-success { padding: 20px 0; }
    .success-icon { color: #10b981; filter: drop-shadow(0 0 15px rgba(16, 185, 129, 0.4)); }
</style>
