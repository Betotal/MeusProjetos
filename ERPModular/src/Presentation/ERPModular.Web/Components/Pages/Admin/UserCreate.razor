@page "/Admin/Users/Create"
@rendermode InteractiveServer

@using ERPModular.Shared.Domain.Models
@using ERPModular.Shared.Infrastructure.Persistence
@using ERPModular.Shared.Infrastructure.Extensions
@using Microsoft.AspNetCore.Identity
@using Microsoft.JSInterop
@using System.ComponentModel.DataAnnotations
@attribute [Authorize(Roles = "Admin,Owner")]
@inject IServiceScopeFactory ScopeFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject ERPModular.Web.Services.SaaSControlService SaaSControl


<div class="user-create-container">
    <div class="user-create-card theme-card border-0 shadow-lg p-4 p-md-5 rounded-4">
        <div class="header mb-4 pb-2 border-bottom">
            <h3 class="theme-text-header fw-bold mb-1"><i class="fas fa-user-plus text-accent me-2"></i>Convidar Membro</h3>
            <p class="text-subtitle">Cadastre o funcionário e envie o link de ativação.</p>
        </div>

        @if (InviteLinkGenerated)
        {
            <div class="invite-success animate__animated animate__zoomIn">
                <div class="text-center mb-4">
                    <div class="success-icon mb-3">
                        <i class="fas fa-check-circle fa-4x text-success"></i>
                    </div>
                    <h4 class="theme-text fw-bold">Convite Criado!</h4>
                    <p class="text-subtitle">Compartilhe o link abaixo com <strong>@Model.FullName</strong></p>
                </div>

                <div class="link-box p-3 rounded-4 bg-primary bg-opacity-10 border border-info border-opacity-25 mb-4">
                    <code class="text-accent small text-break">@InviteLink</code>
                </div>

                <div class="d-grid gap-3">
                    <button class="btn btn-success btn-lg py-3 rounded-4 shadow-sm" @onclick="SendWhatsApp">
                        <i class="fab fa-whatsapp me-2"></i> Enviar via WhatsApp
                    </button>
                    <button class="btn @(IsDarkMode ? "btn-outline-light" : "btn-outline-secondary") btn-lg py-3 rounded-4" @onclick="CopyLink">
                        <i class="fas fa-copy me-2"></i> @CopyButtonText
                    </button>
                    <a href="/Admin/Users" class="btn btn-link text-subtitle mt-2">Voltar para a Lista</a>
                </div>
            </div>
        }
        else
        {

        <EditForm Model="Model" OnValidSubmit="HandleCreate" FormName="user-create-form">
            <DataAnnotationsValidator />

            <div class="mb-3">
                <label class="form-label text-subtitle">Nome Completo</label>
                <InputText @bind-Value="Model.FullName" class="form-control theme-input" placeholder="Ex: Maria Souza" />
                <ValidationMessage For="() => Model.FullName" class="text-danger" />
            </div>

            <div class="mb-3">
                <label class="form-label text-subtitle">Nome de Exibição (Como aparecerá no sistema)</label>
                <InputText @bind-Value="Model.DisplayName" class="form-control theme-input" placeholder="Ex: Maria" />
                <ValidationMessage For="() => Model.DisplayName" class="text-danger" />
            </div>

            <div class="mb-3">
                <label class="form-label text-subtitle">E-mail (Login)</label>
                <InputText @bind-Value="Model.Email" class="form-control theme-input" placeholder="funcionario@suaempresa.com" />
                <ValidationMessage For="() => Model.Email" class="text-danger" />
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label text-subtitle">Função (O que o usuário faz)</label>
                    <InputText @bind-Value="Model.Funcao" class="form-control theme-input" placeholder="Ex: Vendedor" />
                    <ValidationMessage For="() => Model.Funcao" class="text-danger" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label text-subtitle">Nível de Acesso</label>
                    <InputSelect @bind-Value="Model.NivelAcesso" class="form-select theme-input">
                        <option value="Consulta">Consulta (Apenas leitura)</option>
                        <option value="Operacional">Operacional (Movimentações)</option>
                        <option value="Total">Total (Gestor)</option>
                    </InputSelect>
                </div>
            </div>

            <div class="mb-4">
                <label class="form-label text-subtitle">Hierarquia de Gestão</label>
                <InputSelect @bind-Value="Model.Role" class="form-select theme-input">
                    <option value="User">Usuário Comum</option>
                    <option value="Admin">Administrador (Gerencia outros usuários)</option>
                </InputSelect>
            </div>
            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i> @ErrorMessage
                </div>
            }
            
            @if (!string.IsNullOrEmpty(SuccessMessage))
            {
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill me-2"></i> @SuccessMessage
                </div>
            }

            <div class="d-flex gap-3 mt-4">

                @* Usando <a> para navegação mais robusta que independe de evento de click *@
                <a href="/Admin/Users" class="btn btn-outline-secondary w-100">Cancelar</a>
                
                <button type="submit" class="btn btn-primary w-100 btn-lg shadow" disabled="@(IsProcessing || IsReadOnly)">

                    @if (IsProcessing)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span> <span>Processando...</span>
                    }
                    else
                    {
                        <span><i class="fas fa-paper-plane me-2"></i>Gerar Convite</span>
                    }
                </button>
            </div>
        </EditForm>
        }
    </div>
</div>

@code {
    private CreateUserModel Model = new();
    private bool IsProcessing = false;
    private string? ErrorMessage;
    private string? SuccessMessage;
    private bool IsReadOnly = false;
    private bool InviteLinkGenerated = false;
    private string InviteLink = "";
    private string CopyButtonText = "Copiar Link";
    private bool IsDarkMode = true;
    [Inject] private IJSRuntime JSRuntime { get; set; } = default!;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var theme = await JSRuntime.InvokeAsync<string>("getTheme");
            IsDarkMode = theme == "dark";
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var tenantId = user.GetTenantId();
        var domainId = user.GetDomainId();

        if (!string.IsNullOrEmpty(tenantId) && !string.IsNullOrEmpty(domainId))
        {
            var (status, _, _) = await SaaSControl.GetLicenseStatusAsync(tenantId, domainId);
            IsReadOnly = (status == ERPModular.Web.Services.LicenseStatus.ReadOnly);
        }
    }

    private async Task HandleCreate()
    {
        IsProcessing = true;
        ErrorMessage = null;
        SuccessMessage = null;

        if (IsReadOnly)
        {
            ErrorMessage = "Acesso Restrito: Sua licença expirou. Não é possível realizar novas operações de escrita.";
            IsProcessing = false;
            return;
        }

        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var currentUser = authState.User;

            var domainId = currentUser.GetDomainId();
            var tenantId = currentUser.GetTenantId();
            var currentUserId = currentUser.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "unknown";
            var currentUserName = currentUser.Identity?.Name ?? "Admin";

            if (string.IsNullOrEmpty(domainId) || string.IsNullOrEmpty(tenantId))
            {
                ErrorMessage = "Erro de contexto: Sessão expirada ou inválida.";
                return;
            }

            using var scope = ScopeFactory.CreateScope();
            var userManager = scope.ServiceProvider.GetRequiredService<UserManager<ERPUser>>();
            var dbContext = scope.ServiceProvider.GetRequiredService<SharedDbContext>();

            var invitationToken = Guid.NewGuid().ToString("N");
            var newUser = new ERPUser
            {
                UserName = Model.Email,
                Email = Model.Email,
                FullName = Model.FullName,
                DisplayName = Model.DisplayName,
                DomainId = domainId,
                TenantId = tenantId,
                EmpresaId = "matriz", 
                Funcao = Model.Funcao,
                NivelAcesso = Model.NivelAcesso,
                InvitationAccepted = false,
                InvitationToken = invitationToken,
                IsActive = true
            };

            // Senha temporária aleatória (será resetada no onboarding)
            var tempPassword = "Tmp@" + Guid.NewGuid().ToString("N").Substring(0, 8);
            var result = await userManager.CreateAsync(newUser, tempPassword);
            
            if (result.Succeeded)
            {
                await userManager.AddToRoleAsync(newUser, Model.Role);
                
                var auditLog = new AdminAuditLog
                {
                    UsuarioId = currentUserId,
                    UsuarioNome = currentUserName,
                    Acao = "Convite de Usuário",
                    Detalhes = $"Convidado usuário '{newUser.Email}' com nível '{newUser.NivelAcesso}'.",
                    TenantId = tenantId,
                    DataHora = DateTime.UtcNow
                };
                
                dbContext.AdminAuditLogs.Add(auditLog);
                await dbContext.SaveChangesAsync();

                // Gerar Link de Convite
                InviteLink = $"{Navigation.BaseUri}Account/Onboarding?email={Uri.EscapeDataString(newUser.Email!)}&token={invitationToken}";
                InviteLinkGenerated = true;
            }
            else
            {
                ErrorMessage = string.Join("; ", result.Errors.Select(e => e.Description));
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "Ocorreu um erro: " + ex.Message;
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private async Task CopyLink()
    {
        await JSRuntime.InvokeVoidAsync("dashboardCharts.copyToClipboard", InviteLink);
        CopyButtonText = "Copiado! ✅";
        await Task.Delay(2000);
        CopyButtonText = "Copiar Link";
    }

    private async Task SendWhatsApp()
    {
        var message = $"Olá {Model.FullName}! Seja bem-vindo ao nosso ERP. Para ativar sua conta e definir sua senha, acesse o link: {InviteLink}";
        var url = $"https://wa.me/?text={Uri.EscapeDataString(message)}";
        await JSRuntime.InvokeVoidAsync("window.open", url, "_blank");
    }

    public class CreateUserModel
    {
        [Required(ErrorMessage = "Nome completo é obrigatório")]
        public string FullName { get; set; } = "";

        [Required(ErrorMessage = "Nome de exibição é obrigatório")]
        [StringLength(30, ErrorMessage = "Máximo de 30 caracteres")]
        public string DisplayName { get; set; } = "";

        [Required(ErrorMessage = "E-mail é obrigatório")]
        [EmailAddress(ErrorMessage = "E-mail inválido")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "A função é obrigatória")]
        public string Funcao { get; set; } = "";

        [Required(ErrorMessage = "O nível de acesso é obrigatório")]
        public string NivelAcesso { get; set; } = "Operacional";

        public string Role { get; set; } = "User";
    }
}

<style>
    .user-create-container { display: flex; justify-content: center; padding: 50px 20px; min-height: 100vh; }
    
    .btn-lg { border-radius: 12px; font-weight: 700; transition: all 0.3s; }
    
    .btn-primary {
        background: var(--accent);
        color: #0f172a;
        font-weight: 700;
        border: none;
    }
    .btn-primary:hover { transform: translateY(-2px); background: #0ea5e9; }
    .btn-success { background: #10b981; border: none; }
</style>
