@page "/Admin/SaaS/Audit"
@rendermode InteractiveServer
@using ERPModular.Shared.Domain.Models

@using Microsoft.JSInterop
@using ERPModular.Shared.Infrastructure.Persistence
@using Microsoft.EntityFrameworkCore
@attribute [Authorize(Roles = "SuperAdmin")]
@inject SharedDbContext DbContext
@inject NavigationManager Navigation

<PageTitle>Central de Auditoria - ERPModular</PageTitle>

<div class="container-fluid pt-2 pb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="theme-text-header fw-bold mb-1">Central de Auditoria</h2>
            <p class="text-subtitle mb-0">Rastreabilidade total de ações administrativas</p>
        </div>
    </div>

    <div class="premium-card border-0 shadow-sm overflow-hidden mb-4">
        <div class="card-header bg-transparent border-bottom p-4">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="text-subtitle small mb-1">Filtrar por Tenant</label>
                    <input type="text" @bind="filterTenant" @bind:event="oninput" 
                           class="form-control theme-input" 
                           placeholder="ID do Tenant..." />
                </div>
                <div class="col-md-3">
                    <label class="text-subtitle small mb-1">Ação</label>
                    <input type="text" @bind="filterAction" @bind:event="oninput" 
                           class="form-control theme-input" 
                           placeholder="Tipo de ação..." />
                </div>
                <div class="col-md-3">
                    <label class="text-subtitle small mb-1">Usuário (Admin)</label>
                    <input type="text" @bind="filterUser" @bind:event="oninput" 
                           class="form-control theme-input" 
                           placeholder="Nome ou ID..." />
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-outline-secondary w-100" @onclick="ClearFilters">
                        Limpar Filtros
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="theme-table-header text-subtitle small">
                        <tr>
                            <th class="ps-4">DATA/HORA</th>
                            <th>AÇÃO</th>
                            <th>ADMINISTRADOR</th>
                            <th>TENANT ALVO</th>
                            <th>DETALHES</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (auditLogs == null)
                        {
                            <tr><td colspan="5" class="text-center py-5"><div class="spinner-border text-accent" role="status"></div></td></tr>
                        }
                        else if (!filteredLogs.Any())
                        {
                            <tr><td colspan="5" class="text-center py-5 text-subtitle">Nenhum log encontrado.</td></tr>
                        }
                        else
                        {
                            @foreach (var log in filteredLogs)
                            {
                                <tr>
                                    <td class="ps-4">
                                        <div class="theme-text">@log.DataHora.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</div>
                                        <small class="text-subtitle extra-small">IP: @(log.IpAddress ?? "N/A")</small>
                                    </td>
                                    <td>
                                        <span class="badge @GetActionClass(log.Acao)">@log.Acao</span>
                                    </td>
                                    <td>
                                        <div class="theme-text">@log.UsuarioNome</div>
                                        <small class="text-subtitle extra-small">ID: @log.UsuarioId.Substring(0,8)</small>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(log.TenantId))
                                        {
                                            <span class="badge bg-secondary">@log.TenantId</span>
                                        }
                                        else
                                        {
                                            <span class="text-subtitle small">-</span>
                                        }
                                    </td>
                                    <td class="small text-subtitle" style="max-width: 300px;">
                                        @log.Detalhes
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    .table tbody tr { transition: all 0.2s ease; }
</style>

@code {
    [Inject] private IJSRuntime JS { get; set; } = default!;
    private List<AdminAuditLog>? auditLogs;
    private string filterTenant = "";
    private string filterAction = "";
    private string filterUser = "";

    [Parameter]
    [SupplyParameterFromQuery]
    public string? tenantId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(tenantId))
        {
            filterTenant = tenantId;
        }

        auditLogs = await DbContext.AdminAuditLogs
            .AsNoTracking()
            .OrderByDescending(l => l.DataHora)
            .Take(500) // Limite de visualização por performance
            .ToListAsync();
    }

    private IEnumerable<AdminAuditLog> filteredLogs => auditLogs?
        .Where(l => (string.IsNullOrEmpty(filterTenant) || l.TenantId?.Contains(filterTenant, StringComparison.OrdinalIgnoreCase) == true) &&
                    (string.IsNullOrEmpty(filterAction) || l.Acao.Contains(filterAction, StringComparison.OrdinalIgnoreCase)) &&
                    (string.IsNullOrEmpty(filterUser) || l.UsuarioNome.Contains(filterUser, StringComparison.OrdinalIgnoreCase) || l.UsuarioId.Contains(filterUser, StringComparison.OrdinalIgnoreCase)))
        ?? Enumerable.Empty<AdminAuditLog>();

    private void ClearFilters()
    {
        filterTenant = "";
        filterAction = "";
        filterUser = "";
        tenantId = null;
    }

    private string GetActionClass(string action) => action switch
    {
        var a when a.Contains("Bloqueio") || a.Contains("Cancel") || a.Contains("Suspen") => "bg-danger-soft text-danger border border-danger border-opacity-25",
        var a when a.Contains("Ativa") || a.Contains("Provision") || a.Contains("Liber") => "bg-success-soft text-success border border-success border-opacity-25",
        var a when a.Contains("Edição") || a.Contains("Altera") => "bg-warning-soft text-warning border border-warning border-opacity-25",
        _ => "bg-info-soft text-info border border-info border-opacity-25"
    };
}
