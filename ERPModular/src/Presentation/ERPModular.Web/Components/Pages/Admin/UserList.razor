@page "/Admin/Users"
@rendermode InteractiveServer
@using ERPModular.Shared.Domain.Models
@using ERPModular.Shared.Infrastructure.Persistence
@using ERPModular.Shared.Infrastructure.Extensions
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using Microsoft.JSInterop
@attribute [Authorize(Roles = "Admin,SuperAdmin,Owner")]
@inject SharedDbContext DbContext
@inject UserManager<ERPUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IServiceScopeFactory ScopeFactory
@inject ERPModular.Web.Services.SaaSControlService SaaSControl


<div class="user-list-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="theme-text-header fw-bold mb-1">Gestão de Usuários</h3>
            @if (IsReadOnly)
            {
                <span class="badge bg-danger mb-2 animate__animated animate__pulse animate__infinite">MODO SOMENTE LEITURA</span>
            }
            <p class="text-subtitle lead small">Gerencie quem tem acesso à tecnologia da sua empresa.</p>
        </div>

        <button class="btn btn-primary" @onclick="GoToCreate" disabled="@IsReadOnly">
            <i class="bi bi-person-plus-fill me-2"></i>Novo Usuário
        </button>

    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> @errorMessage
            <button type="button" class="btn-close" @onclick='() => errorMessage = ""'></button>
        </div>
    }

    @* Alerta de sucesso removido para uma experiência mais ágil conforme solicitação do usuário *@

    <div class="premium-card border-0 shadow-sm overflow-hidden">
        @if (Users == null)
        {
            <div class="text-center p-5">
                <div class="spinner-border text-info" role="status"></div>
            </div>
        }
        else if (!Users.Any())
        {
            <div class="text-center p-5 text-muted">
                <i class="bi bi-people style='font-size: 3rem;'"></i>
                <p class="mt-3">Nenhum usuário encontrado para este tenant.</p>
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                <thead class="theme-table-header">
                    <tr>
                        <th class="ps-4 text-subtitle">Nome</th>
                        <th class="text-subtitle">Função / Nível</th>
                        <th class="text-subtitle">Status</th>
                        <th class="text-subtitle">Criado em</th>
                        <th class="text-end text-subtitle pe-4">
                            Ações
                            <span class="help-icon ms-1" @onclick="() => showHelpModal = true" title="Ajuda sobre as ações">
                                <i class="bi bi-question-circle text-info"></i>
                            </span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in Users)
                    {
                        <tr class="@(user.IsActive ? "" : "opacity-75 bg-danger-soft")">
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle-premium @(user.IsActive ? "bg-accent-soft text-accent" : "bg-danger-soft text-danger") me-3">@((user.DisplayName ?? user.FullName ?? "U")[0])</div>
                                    <div>
                                        <div class="fw-bold theme-text">@((user.DisplayName ?? user.FullName).ToShortName())</div>
                                        <div class="text-subtitle extra-small">@GetRoleDisplayName(user.Id)</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="fw-bold text-accent extra-small">@user.Funcao</div>
                                <div class="text-subtitle extra-small">@user.NivelAcesso</div>
                            </td>
                            <td>
                                @if (!user.InvitationAccepted)
                                {
                                    <span class="badge bg-warning-soft text-warning border border-warning border-opacity-10">
                                        <i class="bi bi-envelope-exclamation me-1"></i> Convite Pendente
                                    </span>
                                }
                                else if (user.IsActive)
                                {
                                    <span class="badge bg-success-soft text-success border border-success border-opacity-10">Ativo</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger-soft text-danger border border-danger border-opacity-10">
                                        <i class="bi bi-person-x-fill me-1"></i> BLOQUEADO
                                    </span>
                                }
                            </td>
                            <td class="theme-text">@user.CreatedAt.ToShortDateString()</td>
                            <td class="text-end pe-4">
                                @if (userPermissions.ContainsKey(user.Id) && userPermissions[user.Id])
                                {
                                    @if (user.InvitationAccepted)
                                    {
                                    @if (user.IsActive && user.ResetPasswordRequested)
                                    {
                                        <button class="btn btn-sm btn-warning fw-bold shadow-sm me-2" 
                                                title="Solicitação de nova senha pendente"
                                                @onclick="() => LiberarSenha(user)">
                                            <i class="bi bi-key-fill me-1"></i> LIBERAR ACESSO
                                        </button>
                                    }
                                    else if (user.ResetPasswordAllowed)
                                    {
                                        <span class="badge bg-success-soft text-success me-2 border border-success border-opacity-25">
                                            <i class="bi bi-unlock-fill me-1"></i> Liberada
                                        </span>
                                    }

                                    @if (!(user.IsActive && user.ResetPasswordRequested))
                                    {
                                        <button class="btn btn-sm @(user.IsActive ? "btn-outline-warning" : "btn-outline-success") me-2" @onclick="() => ToggleUserStatus(user)">
                                            <i class="bi @(user.IsActive ? "bi-lock" : "bi-unlock") me-1"></i> @(user.IsActive ? "Bloquear" : "Ativar")
                                        </button>
                                    }
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-outline-danger me-2" @onclick="() => ConfirmDelete(user)">
                                            <i class="bi bi-trash me-1"></i> Excluir
                                        </button>
                                    }
                                    <button class="btn btn-sm btn-outline-info me-2">
                                        <i class="bi bi-pencil me-1"></i> Editar
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        }
    </div>

    @if (showHelpModal)
    {
        <div class="modal-overlay" @onclick="() => showHelpModal = false">
            <div class="custom-modal theme-card border-0 shadow-lg p-4 rounded-4" style="max-width: 400px;" @onclick:stopPropagation="true">
                <div class="modal-header border-bottom mb-3 pb-2">
                    <h5 class="theme-text fw-bold mb-0"><i class="bi bi-info-circle text-info me-2"></i>Sobre as Ações</h5>
                    <button class="btn-close @(IsDarkMode ? "btn-close-white" : "")" @onclick="() => showHelpModal = false"></button>
                </div>
                <div class="modal-body text-start">
                    <div class="mb-3">
                        <p class="theme-text mb-1"><strong><i class="bi bi-lock text-warning me-2"></i>Bloquear:</strong></p>
                        <p class="text-subtitle small">Suspende temporariamente o acesso do usuário ao sistema.</p>
                    </div>
                    <div class="mb-3">
                        <p class="theme-text mb-1"><strong><i class="bi bi-unlock text-success me-2"></i>Ativar:</strong></p>
                        <p class="text-subtitle small">Restaura o acesso de um usuário que estava bloqueado.</p>
                    </div>
                    <div class="mb-3">
                        <p class="theme-text mb-1"><strong><i class="bi bi-pencil text-info me-2"></i>Editar:</strong></p>
                        <p class="text-subtitle small">Altera dados cadastrais como nome e cargo.</p>
                    </div>
                    <div class="mb-0">
                        <p class="theme-text mb-1"><strong><i class="bi bi-trash text-danger me-2"></i>Excluir:</strong></p>
                        <p class="text-subtitle small">Remove o usuário permanentemente (ação irreversível).</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-info w-100" @onclick="() => showHelpModal = false">Entendi</button>
                </div>
            </div>
        </div>
    }

    @if (userToDelete != null)
    {
        <div class="modal-overlay" @onclick="() => userToDelete = null">
            <div class="custom-modal theme-card border-0 shadow-lg p-4 rounded-4" style="max-width: 450px;" @onclick:stopPropagation="true">
                <div class="modal-header border-bottom mb-3 pb-2">
                    <h5 class="theme-text fw-bold mb-0 text-danger"><i class="bi bi-trash me-2"></i>Excluir Usuário</h5>
                    <button class="btn-close @(IsDarkMode ? "btn-close-white" : "")" @onclick="() => userToDelete = null"></button>
                </div>
                <div class="modal-body text-start">
                    <p class="theme-text">Tem certeza que deseja excluir o usuário:</p>
                    <p class="fw-bold text-warning">@userToDelete.FullName (@userToDelete.Email)</p>
                    <p class="text-subtitle small">O convite ainda não foi aceito. Esta ação é irreversível.</p>
                </div>
                <div class="modal-footer d-flex gap-2">
                    <button class="btn btn-outline-secondary flex-fill" @onclick="() => userToDelete = null">Cancelar</button>
                    <button class="btn btn-danger flex-fill" @onclick="DeleteUser" disabled="@isDeleting">
                        @if (isDeleting) { <span class="spinner-border spinner-border-sm me-1"></span> }
                        <i class="bi bi-trash me-1"></i> Confirmar Exclusão
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Inject] private IJSRuntime JSRuntime { get; set; } = default!;
    private List<ERPUser>? Users;
    private ClaimsPrincipal? currentUser;
    private Dictionary<string, bool> userPermissions = new();
    private string errorMessage = "";
    private bool IsReadOnly = false;
    private bool IsDarkMode = true;

    private bool showHelpModal = false;
    private ERPUser? userToDelete;
    private bool isDeleting = false;
    private List<string> ownerIds = new();
    private List<string> adminIds = new();
    private Dictionary<string, string> userRoles = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var theme = await JSRuntime.InvokeAsync<string>("getTheme");
            IsDarkMode = theme == "dark";
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            errorMessage = "";
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            currentUser = authState.User;
            var tenantId = currentUser.GetTenantId();
            var domainId = currentUser.GetDomainId();
            var isSuperAdmin = currentUser.IsInRole("SuperAdmin");

            if (!string.IsNullOrEmpty(tenantId) && !string.IsNullOrEmpty(domainId))
            {
                var (status, _, _) = await SaaSControl.GetLicenseStatusAsync(tenantId, domainId);
                IsReadOnly = (status == ERPModular.Web.Services.LicenseStatus.ReadOnly);
            }


            // Buscar IDs de usuários que são Owners e Admins
            var owners = await UserManager.GetUsersInRoleAsync("Owner");
            ownerIds = owners.Select(u => u.Id).ToList();
            
            var admins = await UserManager.GetUsersInRoleAsync("Admin");
            adminIds = admins.Select(u => u.Id).ToList();

            // Se for SuperAdmin, vê todos. Se não, filtra pelo tenant logado.
            if (isSuperAdmin)
            {
                Users = await UserManager.Users.OrderByDescending(u => u.CreatedAt).ToListAsync();
            }
            else
            {
                Users = await UserManager.Users
                    .Where(u => u.TenantId == tenantId)
                    .OrderByDescending(u => u.CreatedAt)
                    .ToListAsync();
            }

            // Pré-carregar permissões de gerenciamento
            if (Users != null)
            {
                foreach (var user in Users)
                {
                    userPermissions[user.Id] = CalculatePermissionSync(user);
                    
                    // Categorização de papel (Simples para a UI)
                    if (ownerIds.Contains(user.Id)) userRoles[user.Id] = "Proprietário";
                    else if (adminIds.Contains(user.Id)) userRoles[user.Id] = "Administrador";
                    else userRoles[user.Id] = "Usuário";
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Erro ao carregar usuários: " + ex.Message;
        }
    }

    private bool CalculatePermissionSync(ERPUser targetUser)
    {
        if (currentUser == null) return false;
        
        var currentUserId = currentUser.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (targetUser.Id == currentUserId) return false; // Anti-AutoBloqueio

        if (currentUser.IsInRole("SuperAdmin")) return true;

        var myTenantId = currentUser.GetTenantId();

        // Dono (Owner) pode gerenciar Admins e Users do seu tenant
        if (currentUser.IsInRole("Owner"))
        {
            return targetUser.TenantId == myTenantId;
        }

        // Administrador pode gerenciar outros Admins e Users, mas não o Dono (Owner)
        if (currentUser.IsInRole("Admin"))
        {
            if (ownerIds.Contains(targetUser.Id)) return false; // Proteção estrita para o Dono
            
            return targetUser.TenantId == myTenantId;
        }

        return false;
    }

    private async Task ToggleUserStatus(ERPUser user)
    {
        try 
        {
            errorMessage = "";
            if (IsReadOnly)
            {
                errorMessage = "Acesso Restrito: Não é possível alterar o status de usuários no modo Somente Leitura.";
                return;
            }

            
            if (!CalculatePermissionSync(user))
            {
                errorMessage = "Você não tem permissão para realizar esta ação.";
                return;
            }

            // [LOG] Início do processo
            Console.WriteLine($"[BLOQUEIO] Tentando alterar status de: {user.Email}. Status Atual: {user.IsActive}");

            // BUSCA ROBUSTA EM ESCOPO SEPARADO para evitar concorrência
            using var scope = ScopeFactory.CreateScope();
            var userManager = scope.ServiceProvider.GetRequiredService<UserManager<ERPUser>>();
            var dbContext = scope.ServiceProvider.GetRequiredService<SharedDbContext>();

            var dbUser = await userManager.FindByIdAsync(user.Id);
            if (dbUser == null)
            {
                errorMessage = "Usuário não encontrado no banco de dados.";
                return;
            }

            dbUser.IsActive = !dbUser.IsActive;
            
            // 1. Update via UserManager (Garante SecurityStamp e persistência padrão)
            var result = await userManager.UpdateAsync(dbUser);
            
            if (result.Succeeded)
            {
                user.IsActive = dbUser.IsActive; // Sincroniza a UI local

                if (!dbUser.IsActive)
                {
                    await userManager.UpdateSecurityStampAsync(dbUser);
                }

                // AUDITORIA: Registrar a ação administrativa
                var currentUserId = currentUser?.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "unknown";
                var currentUserName = currentUser?.Identity?.Name ?? "Desconhecido";
                
                var auditLog = new AdminAuditLog
                {
                    UsuarioId = currentUserId,
                    UsuarioNome = currentUserName,
                    Acao = dbUser.IsActive ? "Ativação de Usuário" : "Bloqueio de Usuário",
                    Detalhes = $"Usuário '{dbUser.Email}' foi {(dbUser.IsActive ? "ativado" : "bloqueado")}. Tenant: {dbUser.TenantId}",
                    TenantId = dbUser.TenantId,
                    IpAddress = null // Pode ser capturado via HttpContext se necessário
                };
                
                dbContext.AdminAuditLogs.Add(auditLog);
                await dbContext.SaveChangesAsync();

                // successMessage removido para agilidade na UI
                Console.WriteLine($"[BLOQUEIO] SUCESSO! Novo Status no Banco: {dbUser.IsActive}");
                
                // Recalcula permissão
                userPermissions[user.Id] = CalculatePermissionSync(user);
            }
            else
            {
                errorMessage = "Erro ao atualizar status: " + string.Join(", ", result.Errors.Select(e => e.Description));
                Console.WriteLine($"[BLOQUEIO] FALHA: {errorMessage}");
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Falha técnica ao tentar alterar o status: " + ex.Message;
            Console.WriteLine($"[BLOQUEIO] ERRO CRÍTICO: {ex.Message}");
        }
    }

    private void GoToCreate() => Navigation.NavigateTo("/Admin/Users/Create");

    private string CleanName(string fullName) => fullName.Split(" - ")[0].ToShortName();

    private string GetRoleDisplayName(string userId)
    {
        if (userRoles.TryGetValue(userId, out var role)) return role;
        return "Usuário"; 
    }

    private void ConfirmDelete(ERPUser user)
    {
        // Só permite excluir se o convite ainda não foi aceito
        if (user.InvitationAccepted) return;
        if (!CalculatePermissionSync(user)) return;
        userToDelete = user;
    }

    private async Task DeleteUser()
    {
        if (userToDelete == null) return;

        if (IsReadOnly)
        {
            errorMessage = "Acesso Restrito: Não é possível excluir usuários no modo Somente Leitura.";
            userToDelete = null;
            return;
        }
        if (userToDelete.InvitationAccepted)
        {
            errorMessage = "Não é possível excluir um usuário que já acessou o sistema.";
            userToDelete = null;
            return;
        }

        isDeleting = true;
        try
        {
            using var scope = ScopeFactory.CreateScope();
            var userManager = scope.ServiceProvider.GetRequiredService<UserManager<ERPUser>>();
            var dbContext = scope.ServiceProvider.GetRequiredService<SharedDbContext>();

            var dbUser = await userManager.FindByIdAsync(userToDelete.Id);
            if (dbUser == null || dbUser.InvitationAccepted)
            {
                errorMessage = "Operação não permitida.";
                return;
            }

            var currentUserId = currentUser?.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "unknown";
            var currentUserName = currentUser?.Identity?.Name ?? "Desconhecido";

            var result = await userManager.DeleteAsync(dbUser);
            if (result.Succeeded)
            {
                var auditLog = new AdminAuditLog
                {
                    UsuarioId = currentUserId,
                    UsuarioNome = currentUserName,
                    Acao = "Exclusão de Usuário (Convite Pendente)",
                    Detalhes = $"Usuário '{dbUser.Email}' excluído pois o convite não havia sido aceito.",
                    TenantId = dbUser.TenantId,
                    DataHora = DateTime.UtcNow
                };
                dbContext.AdminAuditLogs.Add(auditLog);
                await dbContext.SaveChangesAsync();

                Users?.Remove(userToDelete);
                userToDelete = null;
            }
            else
            {
                errorMessage = "Erro ao excluir: " + string.Join(", ", result.Errors.Select(e => e.Description));
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Erro ao excluir usuário: " + ex.Message;
        }
        finally
        {
            isDeleting = false;
        }
    }

    private async Task LiberarSenha(ERPUser user)
    {
        try
        {
            errorMessage = "";
            if (IsReadOnly)
            {
                errorMessage = "Acesso Restrito: Não é possível liberar senhas no modo Somente Leitura.";
                return;
            }
            using var scope = ScopeFactory.CreateScope();
            var userManager = scope.ServiceProvider.GetRequiredService<UserManager<ERPUser>>();
            var dbContext = scope.ServiceProvider.GetRequiredService<SharedDbContext>();

            var dbUser = await userManager.FindByIdAsync(user.Id);
            if (dbUser == null) return;

            dbUser.ResetPasswordAllowed = true;
            dbUser.ResetPasswordRequested = false; // Consome a solicitação
            await userManager.UpdateAsync(dbUser);
            
            user.ResetPasswordAllowed = true; // Sincroniza UI
            user.ResetPasswordRequested = false;
            
            // Auditoria
            var currentUserId = currentUser?.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "unknown";
            var auditLog = new AdminAuditLog
            {
                UsuarioId = currentUserId,
                UsuarioNome = currentUser?.Identity?.Name ?? "Admin",
                Acao = "Liberação de Senha",
                Detalhes = $"Troca de senha liberada para '{dbUser.Email}'.",
                TenantId = dbUser.TenantId
            };
            dbContext.AdminAuditLogs.Add(auditLog);
            await dbContext.SaveChangesAsync();
        }
        catch (Exception ex)
        {
            errorMessage = "Erro ao liberar senha: " + ex.Message;
        }
    }
}

<style>
    .user-list-container { padding: 10px 30px 30px 30px; }
    
    .table tbody td {
        padding: 15px;
        vertical-align: middle;
        border-bottom: 1px solid var(--border-color);
    }
    .avatar-circle-premium {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 1.2rem;
        transition: all 0.3s ease;
    }
    .badge { padding: 6px 10px; border-radius: 6px; font-weight: 600; font-size: 0.7rem; }

    .help-icon {
        cursor: pointer;
        font-size: 0.9rem;
        transition: transform 0.2s;
        display: inline-block;
        vertical-align: middle;
    }

    .help-icon:hover {
        transform: scale(1.2);
    }
</style>
