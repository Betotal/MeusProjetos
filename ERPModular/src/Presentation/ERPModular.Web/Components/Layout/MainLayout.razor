@inherits LayoutComponentBase
@using ERPModular.Web.Services
@inject SaaSControlService SaaSControl
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpAccessor
@inject AuthenticationStateProvider AuthStateProvider
@using Microsoft.AspNetCore.Components.Authorization

<div class="page shadow-sm">
    <header class="top-header">
        <NavMenu />
    </header>

    <main class="@(HasAlert ? "with-alert" : "")">

        <article class="content px-4">
            @Body
        </article>

        <!-- Rodapé de Aviso de Licenciamento (Visível apenas para Gestores) -->
        <AuthorizeView Roles="Owner,Admin,SuperAdmin">
            @if (HasAlert)
            {
                <div class="licenca-alerta @GetAlertClass() p-2 text-center fixed-bottom">
                    <i class="@GetAlertIcon() me-2"></i>
                    @GetAlertMessage()
                </div>
            }
        </AuthorizeView>
    </main>
</div>

<style>
    .licenca-alerta { 
        z-index: 2000; 
        font-size: 0.95rem; 
        font-weight: 600;
        box-shadow: 0 -4px 15px rgba(0,0,0,0.3);
        left: 250px; 
        width: calc(100% - 250px);
        border-top: 1px solid rgba(255,255,255,0.1);
        backdrop-filter: blur(8px);
        transition: all 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .licenca-alerta.bg-danger {
        background: linear-gradient(90deg, #ef4444 0%, #b91c1c 100%) !important;
    }

    .licenca-alerta.bg-warning {
        background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%) !important;
        color: #0f172a !important;
    }

    .licenca-alerta.bg-info {
        background: linear-gradient(90deg, #38bdf8 0%, #0ea5e9 100%) !important;
        color: #0f172a !important;
    }

    /* No mobile a sidebar colapsa/muda, então o alerta ocupa 100% */
    @@media (max-width: 640.98px) {
        .licenca-alerta {
            left: 0;
            width: 100%;
        }
    }


    /* Adiciona padding ao main para o alerta não cobrir o conteúdo final da página */
    main.with-alert {
        padding-bottom: 50px;
    }
</style>

@code {
    private LicenseStatus GetLicenseStatus()
    {
        var status = HttpAccessor.HttpContext?.Items["LicenseStatus"];
        return status is LicenseStatus s ? s : LicenseStatus.Active;
    }

    private string? GetLicenseWarning() => HttpAccessor.HttpContext?.Items["LicenseWarning"] as string;

    private bool HasAlert => (GetLicenseStatus() != LicenseStatus.Active || !string.IsNullOrEmpty(GetLicenseWarning())) && IsUserManager;

    private bool IsUserManager = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        IsUserManager = user.IsInRole("Owner") || user.IsInRole("Admin") || user.IsInRole("SuperAdmin");
    }

    private string GetAlertClass() => GetLicenseStatus() switch
    {
        LicenseStatus.ReadOnly => "bg-danger text-white",
        LicenseStatus.GracePeriod => "bg-warning text-dark",
        _ => "bg-info text-dark"
    };

    private string GetAlertIcon() => GetLicenseStatus() switch
    {
        LicenseStatus.ReadOnly => "fas fa-lock",
        LicenseStatus.GracePeriod => "fas fa-exclamation-triangle",
        _ => "fas fa-info-circle"
    };

    private string GetAlertMessage()
    {
        var warning = GetLicenseWarning();
        if (!string.IsNullOrEmpty(warning)) return warning;

        return GetLicenseStatus() switch
        {
            LicenseStatus.GracePeriod => $"Licença expirada. A partir de {GetRestrictionDate()}, o acesso será restringido.",
            LicenseStatus.ReadOnly => "Acesso Restrito: Sua licença expirou há mais de 7 dias. O sistema está em modo Somente-Leitura.",
            _ => ""
        };
    }

    private string? GetRestrictionDate()
    {
        var date = HttpAccessor.HttpContext?.Items["RestrictionDate"];
        return date is DateTime d ? d.ToShortDateString() : null;
    }
}

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>
